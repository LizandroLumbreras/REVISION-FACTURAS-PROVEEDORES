<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Comparador CotizaciÃ³n vs Factura (BD)</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{font-family:Arial;background:#f4f6f9;padding:20px}
select,button,input{padding:8px;margin:4px}
button{background:#00416A;color:#fff;border:none;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:20px;background:#fff}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:#00416A;color:#fff}
.total{margin-top:15px;font-size:18px;font-weight:bold;color:#b00020}
input[type=number]{width:70px}
</style>
</head>

<body>

<h2>ðŸ“Š Comparador CotizaciÃ³n vs Factura (BD)</h2>

<label>Proveedor:</label>
<select id="proveedor">
  <option value="">-- Selecciona --</option>
  <option value="ABARROTES">ABARROTES</option>
  <option value="DECASA">DECASA</option>
  <option value="MAS BODEGA">MAS BODEGA</option>
</select>

<button onclick="buscarFacturas()">Buscar facturas</button>

<div id="listaFacturas"></div>

<hr>

<label>CotizaciÃ³n (Excel):</label>
<input type="file" id="excelFile" accept=".xlsx,.xls">

<table>
<thead>
<tr>
  <th>Producto</th>
  <th>Cotizado</th>
  <th>Factura</th>
  <th>Pzas x Caja</th>
  <th>Diferencia</th>
  <th>A descontar</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>

<div class="total" id="total"></div>

<script>
/* ================= SUPABASE ================= */
const supa = supabase.createClient(
  "https://cvpbtjlupswbyxenugpz.supabase.co",
  "TU_ANON_KEY_REAL"
);

let conceptosFactura = [];

/* ================= UTILIDADES ================= */
const num = v => parseFloat(v) || 0;
const norm = t => String(t).toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");

function piezasDesdeDescripcion(d){
  const m = d.match(/(\d+)\s*\/\s*\d+/);
  return m ? parseInt(m[1]) : 1;
}

/* ================= BUSCAR FACTURAS ================= */
async function buscarFacturas(){
  const proveedor = proveedor.value;
  if(!proveedor) return alert("Selecciona proveedor");

  const { data, error } = await supa
    .from("deuda_limpia_pdd")
    .select("uuid_cfdi, razon_social_emisor, fecha, total, conceptos_detalle")
    .ilike("razon_social_emisor", `%${proveedor}%`)
    .order("fecha", { ascending:false });

  if(error){
    console.error(error);
    return alert("Error BD");
  }

  let html = "<ul>";
  data.forEach(f=>{
    html += `
      <li>
        ${f.fecha} â€” ${f.razon_social_emisor} â€” $${f.total}
        <button onclick='usarFactura(${JSON.stringify(f)})'>Usar</button>
      </li>`;
  });
  html += "</ul>";

  listaFacturas.innerHTML = html;
}

/* ================= USAR FACTURA ================= */
function usarFactura(f){
  conceptosFactura = f.conceptos_detalle;
  procesar();
}

/* ================= PROCESAR ================= */
async function procesar(){
  if(!excelFile.files[0] || !conceptosFactura.length){
    alert("Selecciona factura y cotizaciÃ³n");
    return;
  }

  const cotizados = await leerExcel(excelFile.files[0]);

  const facturados = conceptosFactura.map(c=>{
    return {
      descripcion: norm(c.descripcion),
      cajas: num(c.cantidad),
      precioCaja: num(c.valorUnitario),
      piezasCaja: piezasDesdeDescripcion(c.descripcion)
    }
  });

  comparar(cotizados, facturados);
}

/* ================= EXCEL ================= */
function leerExcel(file){
  return new Promise(res=>{
    const r = new FileReader();
    r.onload = e=>{
      const wb = XLSX.read(new Uint8Array(e.target.result),{type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws,{header:1});
      res(
        rows.slice(1).map(r=>{
          const d = norm(r[0]);
          return { clave:d.split(" ").slice(0,2).join(" "), precio:num(r[1]) }
        }).filter(x=>x.precio>0)
      );
    };
    r.readAsArrayBuffer(file);
  });
}

/* ================= COMPARAR ================= */
function comparar(cotizados, facturados){
  tabla.innerHTML="";
  let total=0;

  facturados.forEach(f=>{
    const c = cotizados.find(x=>f.descripcion.includes(x.clave));
    if(!c) return;

    const unitFact = f.precioCaja / f.piezasCaja;
    const dif = unitFact - c.precio;
    const desc = dif>0 ? dif * f.piezasCaja * f.cajas : 0;
    total += desc;

    tabla.innerHTML += `
      <tr>
        <td>${f.descripcion}</td>
        <td>${c.precio.toFixed(2)}</td>
        <td>${unitFact.toFixed(2)}</td>
        <td>${f.piezasCaja}</td>
        <td>${dif.toFixed(2)}</td>
        <td>${desc.toFixed(2)}</td>
      </tr>`;
  });

  totalDiv.innerText = "TOTAL A DESCONTAR: $ " + total.toFixed(2);
}
</script>

</body>
</html>
