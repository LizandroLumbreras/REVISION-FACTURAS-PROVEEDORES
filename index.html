<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Comparador Cotizaci√≥n vs Factura (BD)</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{font-family:Arial;background:#f4f6f9;padding:20px}
select,button,input{padding:8px;margin:4px}
button{background:#00416A;color:#fff;border:none;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:20px;background:#fff}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:#00416A;color:#fff}
.total{margin-top:15px;font-size:18px;font-weight:bold;color:#b00020}
input[type=number]{width:70px}
</style>
</head>

<body>

<h2>üìä Comparador Cotizaci√≥n vs Factura (BD)</h2>

<!-- 1Ô∏è‚É£ SELECTOR DE PROVEEDOR -->
<label>Proveedor:</label>
<select id="proveedor">
  <option value="">-- Selecciona --</option>
  <option value="ABARROTES">ABARROTES</option>
  <option value="DECASA">DECASA</option>
  <option value="MAS BODEGA">MAS BODEGA</option>
</select>

<button onclick="buscarFacturas()">Buscar facturas</button>

<div id="listaFacturas"></div>

<hr>

<!-- 2Ô∏è‚É£ COTIZACI√ìN -->
<label>Cotizaci√≥n (Excel):</label>
<input type="file" id="excelFile" accept=".xlsx,.xls">

<table>
<thead>
<tr>
  <th>Producto</th>
  <th>Cotizado</th>
  <th>Factura</th>
  <th>Pzas x Caja</th>
  <th>Diferencia</th>
  <th>A descontar</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>

<div class="total" id="total"></div>

<script>
/* ================= SUPABASE ================= */
const supa = supabase.createClient(
  "https://cvpbtjlupswbyxenugpz.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY"
);

let xmlActual = null;

/* ================= UTILIDADES ================= */
function limpiarNumero(v){
  return parseFloat(String(v).replace(/[^\d.]/g,'')) || 0;
}
function normalizar(t){
  return String(t).toUpperCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"");
}
function extraerPiezasCaja(desc){
  const m = desc.match(/(\d+)\s*\/\s*\d+/);
  return m ? parseInt(m[1]) : null;
}

/* ================= 3Ô∏è‚É£ BUSCAR FACTURAS ================= */
async function buscarFacturas(){
  const proveedor = document.getElementById("proveedor").value;
  if(!proveedor){ alert("Selecciona proveedor"); return }

  const { data, error } = await supa
    .from("v_deuda_proveedores_v2")
    .select("uuid_cfdi, proveedor, fecha, total, xml_texto, xml_url")
    .ilike("proveedor", `%${proveedor}%`)
    .order("fecha",{ascending:false});

  if(error){ alert("Error al consultar BD"); return }

  let html = "<h4>Facturas:</h4><ul>";
  data.forEach(f=>{
    html += `
      <li>
        ${f.fecha} ‚Äî ${f.proveedor} ‚Äî $${f.total}
        <button onclick='cargarFactura(${JSON.stringify(f)})'>Usar</button>
      </li>`;
  });
  html += "</ul>";

  document.getElementById("listaFacturas").innerHTML = html;
}

/* ================= 4Ô∏è‚É£ CARGAR XML ================= */
async function cargarFactura(f){
  if(f.xml_texto){
    xmlActual = f.xml_texto;
  } else if(f.xml_url){
    const res = await fetch(f.xml_url);
    xmlActual = await res.text();
  } else {
    alert("Factura sin XML");
    return;
  }

  procesar();
}

/* ================= 5Ô∏è‚É£ PROCESO ================= */
async function procesar(){
  if(!xmlActual || !excelFile.files[0]){
    alert("Selecciona factura y cotizaci√≥n");
    return;
  }

  const cotizados = await leerExcel(excelFile.files[0]);
  const facturados = leerXML(xmlActual);

  comparar(cotizados, facturados);
}

/* ================= EXCEL ================= */
function leerExcel(file){
  return new Promise(resolve=>{
    const r = new FileReader();
    r.onload = e=>{
      const wb = XLSX.read(new Uint8Array(e.target.result),{type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws,{header:1});
      const data = rows.slice(1).map(r=>{
        const d = normalizar(r[0]);
        return {
          descripcion:d,
          clave:d.split(" ").slice(0,2).join(" "),
          precio:limpiarNumero(r[1])
        }
      }).filter(x=>x.precio>0);
      resolve(data);
    }
    r.readAsArrayBuffer(file);
  });
}

/* ================= XML ================= */
function leerXML(txt){
  const xml = new DOMParser().parseFromString(txt,"text/xml");
  return [...xml.getElementsByTagName("cfdi:Concepto")].map(c=>{
    const d = normalizar(c.getAttribute("Descripcion"));
    return {
      descripcion:d,
      cajas:limpiarNumero(c.getAttribute("Cantidad")),
      precioCaja:limpiarNumero(c.getAttribute("ValorUnitario")),
      piezasCaja:extraerPiezasCaja(d)
    }
  });
}

/* ================= COMPARAR ================= */
function comparar(cotizados, facturados){
  const tbody = document.getElementById("tabla");
  tbody.innerHTML="";
  let total=0;

  facturados.forEach(f=>{
    const c = cotizados.find(x=>f.descripcion.includes(x.clave));
    if(!c) return;

    const pzas = f.piezasCaja || 1;
    const unitFact = f.precioCaja / pzas;
    const dif = unitFact - c.precio;
    const desc = dif>0 ? dif * pzas * f.cajas : 0;
    total += desc;

    tbody.innerHTML += `
      <tr>
        <td>${f.descripcion}</td>
        <td>${c.precio.toFixed(2)}</td>
        <td>${unitFact.toFixed(2)}</td>
        <td>
          <input type="number" value="${pzas}"
            onchange="this.value=Math.max(1,this.value); procesar()">
        </td>
        <td>${dif.toFixed(2)}</td>
        <td>${desc.toFixed(2)}</td>
      </tr>`;
  });

  document.getElementById("total").innerText =
    "TOTAL A DESCONTAR: $ " + total.toFixed(2);
}
</script>

</body>
</html>
