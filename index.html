<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Comparador CotizaciÃ³n vs Factura</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{
  font-family: Arial, Helvetica, sans-serif;
  background:#f4f6f9;
  padding:20px;
}
h2{color:#00416A}
select,input,button{
  padding:8px;
  margin:6px 6px 6px 0;
}
button{
  background:#00416A;
  color:#fff;
  border:none;
  cursor:pointer;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
  background:#fff;
}
th,td{
  border:1px solid #ccc;
  padding:6px;
  font-size:13px;
  text-align:center;
}
th{
  background:#00416A;
  color:#fff;
}
.total{
  margin-top:15px;
  font-size:18px;
  font-weight:bold;
  color:#b00020;
}
</style>
</head>

<body>

<h2>ðŸ“Š Comparador CotizaciÃ³n vs Factura</h2>

<label>Proveedor:</label>
<select id="proveedor">
  <option value="1">ABARROTES</option>
  <option value="2">SAHUAYO</option>
  <option value="3">DETALLE Y DISTRIBUCION</option>
  <option value="4">DECASA</option>
</select>

<br>

<input type="file" id="excelFile" accept=".xlsx,.xls">
<input type="file" id="xmlFile" accept=".xml">

<br>
<button onclick="procesar()">COMPARAR</button>

<table>
<thead>
<tr>
  <th>Producto</th>
  <th>Cotizado</th>
  <th>Factura</th>
  <th>Pzas x Caja</th>
  <th>Diferencia</th>
  <th>A descontar</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>

<div class="total" id="total"></div>

<script>
// ================= UTILIDADES =================
function limpiarNumero(v){
  return parseFloat(String(v).replace(/[^\d.]/g,'')) || 0
}

function normalizar(t){
  return String(t)
    .toUpperCase()
    .replace(/Ã/g,'A')
    .replace(/Ã‰/g,'E')
    .replace(/Ã/g,'I')
    .replace(/Ã“/g,'O')
    .replace(/Ãš/g,'U')
    .replace(/\s+/g,' ')
    .trim()
}

// clave base para empatar productos
function obtenerClave(descripcion){
  const ignorar = ['DE','DEL','LA','EL','EN','Y','CON','SIN','ML','GR','KG','L']
  const partes = descripcion.split(' ')
  return partes.find(p => p.length > 3 && !ignorar.includes(p)) || ''
}
function dividirSeguro(a,b){
  return b > 0 ? a / b : a
}

function extraerPiezasCaja(descripcion){
  // patrones tipo 12/237, 48/130, 30/250
  const m = descripcion.match(/(\d+)\s*\/\s*\d+/)
  if(m) return parseInt(m[1])

  // patrones alternos
  const patrones = [
    /C\/\s*(\d+)/,
    /CJ\s*(\d+)/,
    /CAJA\s*(\d+)/,
    /(\d+)\s*PZ/,
    /(\d+)\s*PIEZAS/
  ]

  for(const p of patrones){
    const x = descripcion.match(p)
    if(x) return parseInt(x[1])
  }

  return null
}

// ================= PROCESO PRINCIPAL =================
async function procesar(){
  const excel = excelFile.files[0]
  const xml = xmlFile.files[0]
  if(!excel || !xml){
    alert('Sube el Excel y el XML')
    return
  }

  const proveedorIndex = parseInt(document.getElementById('proveedor').value)

  const cotizados = await leerExcel(excel, proveedorIndex)
  const facturados = await leerXML(xml)

  comparar(cotizados, facturados)
}

// ================= LECTURA EXCEL =================
function leerExcel(file, colPrecio){
  return new Promise(resolve=>{
    const reader = new FileReader()
    reader.onload = e=>{
      const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'})
      const ws = wb.Sheets[wb.SheetNames[0]]
      const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:''})

      const headerIndex = rows.findIndex(r =>
        String(r[0]).toUpperCase().includes('DESCRIP')
      )

      if(headerIndex === -1){
        alert('No se encontrÃ³ DESCRIPCION en el Excel')
        resolve([])
        return
      }

const data = rows.slice(headerIndex + 1)
  .map(r => {
    const desc = normalizar(r[0])
    return {
      descripcion: desc,
      clave: obtenerClave(desc),
      precioPieza: limpiarNumero(r[colPrecio]),   // precio por pieza
      cajas: limpiarNumero(r[5]),
      piezasCaja: limpiarNumero(r[6]) || 1        // PIEZAS_X_CAJA
    }
  })
  .filter(r => r.clave && r.precioPieza > 0)


      resolve(data)
    }
    reader.readAsArrayBuffer(file)
  })
}

// ================= LECTURA XML =================
function leerXML(file){
  return new Promise(resolve=>{
    const reader = new FileReader()
    reader.onload = e=>{
      const xml = new DOMParser().parseFromString(e.target.result,'text/xml')

      const conceptos = [...xml.getElementsByTagName('*')]
        .filter(n => n.localName === 'Concepto')

const data = conceptos.map(c=>{
  const desc = normalizar(c.getAttribute('Descripcion'))
  return {
    descripcion: desc,
    cajas: limpiarNumero(c.getAttribute('Cantidad')),
    precioCaja: limpiarNumero(c.getAttribute('ValorUnitario')),
    piezasCaja: extraerPiezasCaja(desc) // ðŸ‘ˆ CLAVE
  }
})


      resolve(data)
    }
    reader.readAsText(file)
  })
}

// ================= COMPARACIÃ“N POR CLAVE =================
function comparar(cotizados, facturados){
  const tbody = document.getElementById('tabla')
  tbody.innerHTML = ''
  let total = 0

  facturados.forEach(f=>{
    const c = cotizados.find(x => f.descripcion.includes(x.clave))
    if(!c) return

    // prioridad: XML â†’ Excel â†’ 1
    const piezasCaja = f.piezasCaja || c.piezasCaja || 1

    const precioFacturaPieza = dividirSeguro(f.precioCaja, piezasCaja)
    const piezasTotales = f.cajas * piezasCaja

    if(precioFacturaPieza > c.precioPieza){
      const dif = precioFacturaPieza - c.precioPieza
      const desc = dif * piezasTotales
      total += desc

      tbody.innerHTML += `
        <tr>
          <td>${f.descripcion}</td>
          <td>${c.precioPieza.toFixed(2)}</td>
          <td>${precioFacturaPieza.toFixed(2)}</td>
          <td>
  <input type="number"
         value="${piezasCaja}"
         min="1"
         style="width:70px"
         onchange="recalcularFila(this, ${f.cajas}, ${c.precioPieza}, ${f.precioCaja})">
</td>
          <td>+${dif.toFixed(2)}</td>
          <td>${desc.toFixed(2)}</td>
        </tr>
      `
    }
  })

  document.getElementById('total').innerText =
    'TOTAL A DESCONTAR: $ ' + total.toFixed(2)
}
function recalcularFila(input, cajas, precioCotizado, precioCaja){
  const piezasCaja = parseFloat(input.value) || 1

  const precioUnitarioFactura = precioCaja / piezasCaja
  const diferencia = precioUnitarioFactura - precioCotizado

  const piezasTotales = piezasCaja * cajas
  const descuento = diferencia > 0 ? diferencia * piezasTotales : 0

  const fila = input.closest('tr')
  fila.children[2].innerText = precioUnitarioFactura.toFixed(2)
  fila.children[4].innerText = '+' + diferencia.toFixed(2)
  fila.children[5].innerText = descuento.toFixed(2)

  // tip visual opcional
  input.title = `Piezas totales: ${piezasTotales}`

  recalcularTotal()
}

function recalcularTotal(){
  let total = 0
  document.querySelectorAll('#tabla tr').forEach(tr=>{
    const val = parseFloat(tr.children[5].innerText)
    if(!isNaN(val)) total += val
  })
  document.getElementById('total').innerText =
    'TOTAL A DESCONTAR: $ ' + total.toFixed(2)
}

</script>

</body>
</html>
