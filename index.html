<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Comparador CotizaciÃ³n vs Factura</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{
  font-family: Arial, Helvetica, sans-serif;
  background:#f4f6f9;
  padding:20px;
}
h2{color:#00416A}
select,input,button{
  padding:8px;
  margin:6px 6px 6px 0;
}
button{
  background:#00416A;
  color:#fff;
  border:none;
  cursor:pointer;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
  background:#fff;
}
th,td{
  border:1px solid #ccc;
  padding:6px;
  font-size:13px;
  text-align:center;
}
th{
  background:#00416A;
  color:#fff;
}
.total{
  margin-top:15px;
  font-size:18px;
  font-weight:bold;
  color:#b00020;
}
</style>
</head>

<body>

<h2>ðŸ“Š Comparador CotizaciÃ³n vs Factura</h2>

<label>Proveedor:</label>
<select id="proveedor">
  <option value="1">ABARROTES</option>
  <option value="2">SAHUAYO</option>
  <option value="3">DETALLE Y DISTRIBUCION</option>
  <option value="4">DECASA</option>
</select>

<br>

<input type="file" id="excelFile" accept=".xlsx,.xls">
<input type="file" id="xmlFile" accept=".xml">

<br>
<button onclick="procesar()">COMPARAR</button>

<table>
<thead>
<tr>
  <th>Producto</th>
  <th>Cotizado</th>
  <th>Factura</th>
  <th>Cantidad</th>
  <th>Diferencia</th>
  <th>A descontar</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>

<div class="total" id="total"></div>

<script>
// ================= UTILIDADES =================
function limpiarNumero(v){
  return parseFloat(String(v).replace(/[^\d.]/g,'')) || 0
}

function normalizar(t){
  return String(t)
    .toUpperCase()
    .replace(/Ã/g,'A')
    .replace(/Ã‰/g,'E')
    .replace(/Ã/g,'I')
    .replace(/Ã“/g,'O')
    .replace(/Ãš/g,'U')
    .replace(/\s+/g,' ')
    .trim()
}

// clave base para empatar productos
function obtenerClave(descripcion){
  const ignorar = ['DE','DEL','LA','EL','EN','Y','CON','SIN','ML','GR','KG','L']
  const partes = descripcion.split(' ')
  return partes.find(p => p.length > 3 && !ignorar.includes(p)) || ''
}

// ================= PROCESO PRINCIPAL =================
async function procesar(){
  const excel = excelFile.files[0]
  const xml = xmlFile.files[0]
  if(!excel || !xml){
    alert('Sube el Excel y el XML')
    return
  }

  const proveedorIndex = parseInt(document.getElementById('proveedor').value)

  const cotizados = await leerExcel(excel, proveedorIndex)
  const facturados = await leerXML(xml)

  comparar(cotizados, facturados)
}

// ================= LECTURA EXCEL =================
function leerExcel(file, colPrecio){
  return new Promise(resolve=>{
    const reader = new FileReader()
    reader.onload = e=>{
      const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'})
      const ws = wb.Sheets[wb.SheetNames[0]]
      const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:''})

      const headerIndex = rows.findIndex(r =>
        String(r[0]).toUpperCase().includes('DESCRIP')
      )

      if(headerIndex === -1){
        alert('No se encontrÃ³ DESCRIPCION en el Excel')
        resolve([])
        return
      }

      const data = rows.slice(headerIndex + 1)
        .map(r => {
          const desc = normalizar(r[0])
          return {
            descripcion: desc,
            clave: obtenerClave(desc),
            precio: limpiarNumero(r[colPrecio]),
            cantidad: limpiarNumero(r[5])
          }
        })
        .filter(r => r.clave && r.precio > 0)

      resolve(data)
    }
    reader.readAsArrayBuffer(file)
  })
}

// ================= LECTURA XML =================
function leerXML(file){
  return new Promise(resolve=>{
    const reader = new FileReader()
    reader.onload = e=>{
      const xml = new DOMParser().parseFromString(e.target.result,'text/xml')

      const conceptos = [...xml.getElementsByTagName('*')]
        .filter(n => n.localName === 'Concepto')

      const data = conceptos.map(c=>{
        const desc = normalizar(c.getAttribute('Descripcion'))
        return {
          descripcion: desc,
          cantidad: limpiarNumero(c.getAttribute('Cantidad')),
          precio: limpiarNumero(c.getAttribute('ValorUnitario'))
        }
      })

      resolve(data)
    }
    reader.readAsText(file)
  })
}

// ================= COMPARACIÃ“N POR CLAVE =================
function comparar(cotizados, facturados){
  const tbody = document.getElementById('tabla')
  tbody.innerHTML = ''
  let total = 0

  facturados.forEach(f=>{
    const c = cotizados.find(x => f.descripcion.includes(x.clave))
    if(!c) return

    if(f.precio > c.precio){
      const dif = f.precio - c.precio
      const desc = dif * f.cantidad
      total += desc

      tbody.innerHTML += `
        <tr>
          <td>${f.descripcion}</td>
          <td>${c.precio.toFixed(2)}</td>
          <td>${f.precio.toFixed(2)}</td>
          <td>${f.cantidad}</td>
          <td>+${dif.toFixed(2)}</td>
          <td>${desc.toFixed(2)}</td>
        </tr>
      `
    }
  })

  document.getElementById('total').innerText =
    'TOTAL A DESCONTAR: $ ' + total.toFixed(2)
}
</script>

</body>
</html>
