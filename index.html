<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Comparador CotizaciÃ³n vs Factura (BD)</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>

<style>
body{font-family:Arial;background:#f4f6f9;padding:20px}
select,button,input{padding:8px;margin:4px}
button{background:#00416A;color:#fff;border:none;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:20px;background:#fff}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:#00416A;color:#fff}
.total{margin-top:15px;font-size:18px;font-weight:bold;color:#b00020}
input[type=number]{width:70px}
tr.falta{background:#fff6c2}
</style>
</head>

<body>

<h2>ðŸ“Š Comparador CotizaciÃ³n vs Factura (BD)</h2>

<label>Proveedor:</label>
<select id="proveedor">
  <option value="">-- Selecciona --</option>
  <option value="ABARROTES">ABARROTES</option>
  <option value="DECASA">DECASA</option>
  <option value="MAS BODEGA">MAS BODEGA</option>
</select>

<button onclick="buscarFacturas()">Buscar facturas</button>

<div id="listaFacturas"></div>

<hr>

<label>CotizaciÃ³n (Excel):</label>
<input type="file" id="excelFile" accept=".xlsx,.xls">

<table>
<thead>
<tr>
  <th>Producto</th>
  <th>Cotizado</th>
  <th>Factura</th>
  <th>Pzas x Caja</th>
  <th>Diferencia</th>
  <th>A descontar</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>

<div class="total" id="total"></div>

<script>
/* ================= SUPABASE ================= */
const supa = supabase.createClient(
  "https://cvpbtjlupswbyxenugpz.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY"
);

let conceptosFactura = [];

/* ================= UTILIDADES ================= */
function normalizar(t){
  return String(t).toUpperCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"");
}
function limpiarNumero(v){
  return parseFloat(v) || 0;
}
function extraerPiezas(desc){
  const m = desc.match(/(\d+)\s*\/\s*\d+/);
  return m ? parseInt(m[1]) : null;
}
function limpiarPalabrasClave(texto) {
  return texto
    .replace(/[^A-Z\s]/g, "")
    .split(" ")
    .filter(p =>
      p.length > 3 &&
      !["ML", "GR", "KG", "PZ", "LT", "LITRO", "PAQ", "MAS"].includes(p)
    );
}

function matchProducto(descFactura, descCotizacion) {
  const limpiar = t =>
    t
      .replace(/\d+/g, "")           // quita nÃºmeros
      .replace(/GR|G|ML|LT|KG/g, "") // quita unidades
      .replace(/\s+/g, " ")
      .trim();

  const f = limpiar(descFactura).split(" ");
  const c = limpiar(descCotizacion).split(" ");

  let hits = 0;
  f.forEach(p => {
    if (p.length >= 4 && c.includes(p)) hits++;
  });

  return hits >= 1; // ðŸ”¥ SOLO 1 palabra fuerte
}

/* ================= BUSCAR FACTURAS ================= */
async function buscarFacturas(){
  const proveedorSel = document.getElementById("proveedor").value;
  if(!proveedorSel){ alert("Selecciona proveedor"); return }

  const { data, error } = await supa
    .from("deuda_limpia_pdd")
    .select("uuid_cfdi, fecha, total, conceptos_detalle, razon_social_emisor")
    .ilike("razon_social_emisor", `%${proveedorSel}%`)
    .order("fecha",{ascending:false})
    .limit(10);

  if(error){
    console.error(error);
    alert("Error al consultar BD");
    return;
  }

  let html = "<h4>Facturas:</h4><ul>";
  data.forEach(f=>{
    html += `
      <li>
        ${f.fecha.split("T")[0]} â€” $${f.total}
        <button onclick='usarFactura(${JSON.stringify(f.conceptos_detalle)})'>Usar</button>
      </li>`;
  });
  html += "</ul>";
  document.getElementById("listaFacturas").innerHTML = html;
}

/* ================= USAR FACTURA ================= */
function usarFactura(conceptos){
  conceptosFactura = conceptos.map(c=>({
    descripcion: normalizar(c.descripcion),
    cajas: limpiarNumero(c.cantidad),
    precioCaja: limpiarNumero(c.valorUnitario),
    piezasCaja: extraerPiezas(c.descripcion)
  }));
  procesar();
}

/* ================= PROCESAR ================= */
async function procesar(){
  if(!conceptosFactura.length || !excelFile.files[0]){
    alert("Selecciona factura y cotizaciÃ³n");
    return;
  }
const cotizados = await leerExcel(excelFile.files[0]);
window._cotizados = cotizados; // cache
comparar(cotizados, conceptosFactura);
}

/* ================= EXCEL ================= */
function leerExcel(file){
  return new Promise(resolve=>{
    const r = new FileReader();
    r.onload = e=>{
      const wb = XLSX.read(new Uint8Array(e.target.result),{type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws,{header:1});
      const data = rows.slice(1).map(r=>{
       const desc = limpiarTextoProducto(r[0]);

return {
  descripcion: desc,
  tokens: obtenerTokensClave(desc),
  precio: limpiarNumero(r[1])
}

      }).filter(x=>x.precio>0);
      resolve(data);
    }
    r.readAsArrayBuffer(file);
  });
}
function limpiarTextoProducto(txt){
  return normalizar(txt)
    .replace(/\./g, "")
    .replace(/\s+/g, " ")
    .replace(/GRAMOS?/g, "GR")
    .replace(/MILILITROS?/g, "ML")
    .trim();
}

function obtenerTokensClave(txt){
  return limpiarTextoProducto(txt)
    .split(" ")
    .filter(p =>
      p.length > 3 &&
      !["PARA","CON","MAS","DEL","LAS","LOS","UNA","UNO"].includes(p)
    );
}

/* ================= COMPARAR ================= */
function comparar(cotizados, facturados){
  const tbody = document.getElementById("tabla");
  tbody.innerHTML="";
  let total=0;

  facturados.forEach((f, idx)=>{
const descFactura = limpiarTextoProducto(f.descripcion);
const tokensFactura = obtenerTokensClave(descFactura);

const c = cotizados.find(x => {
  let coincidencias = 0;
  tokensFactura.forEach(t => {
    if (x.tokens.includes(t)) coincidencias++;
  });
  return coincidencias >= 2;
});
    const precioCotizado = c ? c.precio : 0;

   const pzas = f.piezasCaja && f.piezasCaja > 0
  ? Number(f.piezasCaja)
  : 1;

    const precioUnitFact = f.precioCaja / pzas;
   const diferencia = c ? (precioUnitFact - c.precio) : 0;

const descuento = c && diferencia > 0
  ? diferencia * pzas * f.cajas
  : 0;

    total += descuento;

    tbody.innerHTML += `
      <tr class="${!c ? 'falta' : (!f.piezasCaja ? 'falta' : '')}">
        <td>${f.descripcion}</td>
        <td>${c ? c.precio.toFixed(2) : "â€”"}</td>
        <td>${precioUnitFact.toFixed(2)}</td>
        <td>
          <input type="number" min="1" value="${pzas}"
            onchange="actualizarPiezas(${idx}, this.value)">
        </td>
        <td>${diferencia.toFixed(2)}</td>
        <td>${descuento.toFixed(2)}</td>
      </tr>`;
  });

  document.getElementById("total").innerText =
    "TOTAL A DESCONTAR: $ " + total.toFixed(2);
}
  function actualizarPiezas(idx, valor){
  const pzas = Math.max(1, parseInt(valor) || 1);
  conceptosFactura[idx].piezasCaja = pzas;
  recalcular();
}
function recalcular(){
  const cotizadosCache = window._cotizados;
  if(!cotizadosCache) return;
  comparar(cotizadosCache, conceptosFactura);
}

</script>

</body>
</html>
